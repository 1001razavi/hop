name: Check package updates
description: Checks a package for NPM version updates, if the package.json was changed, and if the package was modified.
inputs:
  package-name:
    type: string
    description: Name of the package
    required: true
outputs:
  npm-version-changed:
    value: ${{ steps.check-npm.outputs.npm-version-changed }}
    description: 'Returns a boolean indicating if there is an NPM version mismatch between the local package.json and the NPM registry.'
  package-version-changed:
    value: ${{ steps.check-package-json.outputs.package-version-changed }}
    description: 'Returns a boolean indicating if the passed-in package.json was changed in any way.'

runs:
  using: composite
  steps:
    - name: Checkout code
      uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b
      with:
        fetch-depth: 0

    - name: Is NPM version changed
      id: check-npm
      if: inputs.package-name == 'sdk'
      shell: bash
      working-directory: ./packages/${{ inputs.package-name }}
      run: |
        CURRENT_VERSION=$(npm info . --json | jq -r '."dist-tags".latest')
        LOCAL_VERSION=$(jq -r '.version' package.json)
        if [[ "$CURRENT_VERSION" != "$LOCAL_VERSION" ]]; then
          echo "npm-version-changed=true" >> $GITHUB_OUTPUT
        else
          echo "npm-version-changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Is modified package.json
      id: check-package-json
      shell: bash
      working-directory: ./packages/${{ inputs.package-name }}
      run: |
        VERSION_DIFF=$(git diff HEAD^ HEAD -- package.json | grep '"version":' || true)
        if [ -z "$VERSION_DIFF" ]; then
          echo "package-version-changed=false" >> $GITHUB_OUTPUT
        else
          echo "package-version-changed=true" >> $GITHUB_OUTPUT
        fi